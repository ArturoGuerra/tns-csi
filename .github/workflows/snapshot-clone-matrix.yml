name: Snapshot & Clone Matrix Tests

on:
  # Run after Integration Tests complete
  workflow_run:
    workflows: ["Integration Tests"]
    types:
      - completed
  # Manual trigger with scenario selection
  workflow_dispatch:
    inputs:
      protocol:
        description: 'Protocol to test'
        required: false
        default: 'nfs'
        type: choice
        options:
          - nfs
          - nvmeof
          - iscsi
      scenario:
        description: 'Scenario to test (empty for all)'
        required: false
        default: ''
        type: choice
        options:
          - ''
          - regular-snapshot
          - detached-snapshot
          - snapshot-restore-cow
          - volume-clone-cow

# Restrict permissions to minimum required
permissions:
  contents: read

# Ensure only one test run at a time
concurrency:
  group: snapshot-clone-matrix
  cancel-in-progress: false

jobs:
  # ==========================================
  # Setup Phase
  # ==========================================

  compute-tag:
    name: Compute Image Tag
    runs-on: new
    # Only run on successful integration tests or manual dispatch
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    outputs:
      image_tag: ${{ steps.tag.outputs.tag }}
    steps:
      - name: Compute image tag from ref
        id: tag
        env:
          WORKFLOW_HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            REF_NAME="$WORKFLOW_HEAD_BRANCH"
          else
            REF_NAME="${{ github.ref_name }}"
          fi

          if [ "$REF_NAME" = "main" ]; then
            TAG="latest"
          else
            TAG=$(echo "$REF_NAME" | sed 's/\//-/g')
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT

  # ==========================================
  # NFS Snapshot/Clone Matrix
  # ==========================================

  nfs-regular-snapshot:
    name: "NFS: Regular Snapshot"
    runs-on: new
    timeout-minutes: 15
    needs: compute-tag
    if: |
      !cancelled() && needs.compute-tag.result == 'success' &&
      (github.event.inputs.protocol == '' || github.event.inputs.protocol == 'nfs') &&
      (github.event.inputs.scenario == '' || github.event.inputs.scenario == 'regular-snapshot')
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
      - uses: fenio/setup-k3s@v5
        with:
          k3s-args: '--write-kubeconfig-mode 644 --disable=traefik --disable=local-storage'
      - uses: ./.github/actions/setup-snapshots
      - name: Install Ginkgo
        run: go install github.com/onsi/ginkgo/v2/ginkgo@latest
      - name: Run Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
          KUBECONFIG: /etc/rancher/k3s/k3s.yaml
        run: |
          echo "=== NFS: Regular Snapshot ==="
          ginkgo -v --focus="should create and restore from a regular snapshot" ./tests/e2e/nfs/...

  nfs-detached-snapshot:
    name: "NFS: Detached Snapshot (zfs send/receive)"
    runs-on: new
    timeout-minutes: 20
    needs: compute-tag
    if: |
      !cancelled() && needs.compute-tag.result == 'success' &&
      (github.event.inputs.protocol == '' || github.event.inputs.protocol == 'nfs') &&
      (github.event.inputs.scenario == '' || github.event.inputs.scenario == 'detached-snapshot')
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
      - uses: fenio/setup-k3s@v5
        with:
          k3s-args: '--write-kubeconfig-mode 644 --disable=traefik --disable=local-storage'
      - uses: ./.github/actions/setup-snapshots
      - name: Install Ginkgo
        run: go install github.com/onsi/ginkgo/v2/ginkgo@latest
      - name: Run Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
          KUBECONFIG: /etc/rancher/k3s/k3s.yaml
        run: |
          echo "=== NFS: Detached Snapshot (survives source deletion) ==="
          ginkgo -v --focus="Detached Snapshot" ./tests/e2e/nfs/...

  nfs-snapshot-restore-cow:
    name: "NFS: Snapshot Restore (COW clone)"
    runs-on: new
    timeout-minutes: 15
    needs: compute-tag
    if: |
      !cancelled() && needs.compute-tag.result == 'success' &&
      (github.event.inputs.protocol == '' || github.event.inputs.protocol == 'nfs') &&
      (github.event.inputs.scenario == '' || github.event.inputs.scenario == 'snapshot-restore-cow')
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
      - uses: fenio/setup-k3s@v5
        with:
          k3s-args: '--write-kubeconfig-mode 644 --disable=traefik --disable=local-storage'
      - uses: ./.github/actions/setup-snapshots
      - name: Install Ginkgo
        run: go install github.com/onsi/ginkgo/v2/ginkgo@latest
      - name: Run Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
          KUBECONFIG: /etc/rancher/k3s/k3s.yaml
        run: |
          echo "=== NFS: Snapshot Restore (COW clone - space efficient) ==="
          ginkgo -v --focus="Snapshot Restore" ./tests/e2e/nfs/...

  nfs-volume-clone-cow:
    name: "NFS: Volume Clone (COW)"
    runs-on: new
    timeout-minutes: 15
    needs: compute-tag
    if: |
      !cancelled() && needs.compute-tag.result == 'success' &&
      (github.event.inputs.protocol == '' || github.event.inputs.protocol == 'nfs') &&
      (github.event.inputs.scenario == '' || github.event.inputs.scenario == 'volume-clone-cow')
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
      - uses: fenio/setup-k3s@v5
        with:
          k3s-args: '--write-kubeconfig-mode 644 --disable=traefik --disable=local-storage'
      - uses: ./.github/actions/setup-snapshots
      - name: Install Ginkgo
        run: go install github.com/onsi/ginkgo/v2/ginkgo@latest
      - name: Run Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
          KUBECONFIG: /etc/rancher/k3s/k3s.yaml
        run: |
          echo "=== NFS: Volume-to-Volume Clone (COW - space efficient) ==="
          ginkgo -v --focus="Volume Clone" ./tests/e2e/nfs/...

  # ==========================================
  # NVMe-oF Snapshot/Clone Matrix
  # ==========================================

  nvmeof-regular-snapshot:
    name: "NVMe-oF: Regular Snapshot"
    runs-on: new
    timeout-minutes: 20
    needs: compute-tag
    if: |
      !cancelled() && needs.compute-tag.result == 'success' &&
      (github.event.inputs.protocol == '' || github.event.inputs.protocol == 'nvmeof') &&
      (github.event.inputs.scenario == '' || github.event.inputs.scenario == 'regular-snapshot')
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
      - uses: fenio/setup-k3s@v5
        with:
          k3s-args: '--write-kubeconfig-mode 644 --disable=traefik --disable=local-storage'
      - uses: ./.github/actions/setup-snapshots
      - name: Install Ginkgo
        run: go install github.com/onsi/ginkgo/v2/ginkgo@latest
      - name: Run Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
          KUBECONFIG: /etc/rancher/k3s/k3s.yaml
        run: |
          echo "=== NVMe-oF: Regular Snapshot ==="
          ginkgo -v --focus="should create and restore from a regular snapshot" ./tests/e2e/nvmeof/...

  nvmeof-detached-snapshot:
    name: "NVMe-oF: Detached Snapshot (zfs send/receive)"
    runs-on: new
    timeout-minutes: 25
    needs: compute-tag
    if: |
      !cancelled() && needs.compute-tag.result == 'success' &&
      (github.event.inputs.protocol == '' || github.event.inputs.protocol == 'nvmeof') &&
      (github.event.inputs.scenario == '' || github.event.inputs.scenario == 'detached-snapshot')
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
      - uses: fenio/setup-k3s@v5
        with:
          k3s-args: '--write-kubeconfig-mode 644 --disable=traefik --disable=local-storage'
      - uses: ./.github/actions/setup-snapshots
      - name: Install Ginkgo
        run: go install github.com/onsi/ginkgo/v2/ginkgo@latest
      - name: Run Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
          KUBECONFIG: /etc/rancher/k3s/k3s.yaml
        run: |
          echo "=== NVMe-oF: Detached Snapshot (survives source deletion) ==="
          ginkgo -v --focus="Detached Snapshot" ./tests/e2e/nvmeof/...

  nvmeof-snapshot-restore-cow:
    name: "NVMe-oF: Snapshot Restore (COW clone)"
    runs-on: new
    timeout-minutes: 20
    needs: compute-tag
    if: |
      !cancelled() && needs.compute-tag.result == 'success' &&
      (github.event.inputs.protocol == '' || github.event.inputs.protocol == 'nvmeof') &&
      (github.event.inputs.scenario == '' || github.event.inputs.scenario == 'snapshot-restore-cow')
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
      - uses: fenio/setup-k3s@v5
        with:
          k3s-args: '--write-kubeconfig-mode 644 --disable=traefik --disable=local-storage'
      - uses: ./.github/actions/setup-snapshots
      - name: Install Ginkgo
        run: go install github.com/onsi/ginkgo/v2/ginkgo@latest
      - name: Run Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
          KUBECONFIG: /etc/rancher/k3s/k3s.yaml
        run: |
          echo "=== NVMe-oF: Snapshot Restore (COW clone - space efficient) ==="
          ginkgo -v --focus="Snapshot Restore" ./tests/e2e/nvmeof/...

  nvmeof-volume-clone-cow:
    name: "NVMe-oF: Volume Clone (COW)"
    runs-on: new
    timeout-minutes: 20
    needs: compute-tag
    if: |
      !cancelled() && needs.compute-tag.result == 'success' &&
      (github.event.inputs.protocol == '' || github.event.inputs.protocol == 'nvmeof') &&
      (github.event.inputs.scenario == '' || github.event.inputs.scenario == 'volume-clone-cow')
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
      - uses: fenio/setup-k3s@v5
        with:
          k3s-args: '--write-kubeconfig-mode 644 --disable=traefik --disable=local-storage'
      - uses: ./.github/actions/setup-snapshots
      - name: Install Ginkgo
        run: go install github.com/onsi/ginkgo/v2/ginkgo@latest
      - name: Run Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
          KUBECONFIG: /etc/rancher/k3s/k3s.yaml
        run: |
          echo "=== NVMe-oF: Volume-to-Volume Clone (COW - space efficient) ==="
          ginkgo -v --focus="Volume Clone" ./tests/e2e/nvmeof/...

  # ==========================================
  # iSCSI Snapshot/Clone Matrix
  # ==========================================

  iscsi-regular-snapshot:
    name: "iSCSI: Regular Snapshot"
    runs-on: new
    timeout-minutes: 20
    needs: compute-tag
    if: |
      !cancelled() && needs.compute-tag.result == 'success' &&
      (github.event.inputs.protocol == '' || github.event.inputs.protocol == 'iscsi') &&
      (github.event.inputs.scenario == '' || github.event.inputs.scenario == 'regular-snapshot')
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
      - uses: fenio/setup-k3s@v5
        with:
          k3s-args: '--write-kubeconfig-mode 644 --disable=traefik --disable=local-storage'
      - uses: ./.github/actions/setup-snapshots
      - name: Install Ginkgo
        run: go install github.com/onsi/ginkgo/v2/ginkgo@latest
      - name: Run Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
          KUBECONFIG: /etc/rancher/k3s/k3s.yaml
        run: |
          echo "=== iSCSI: Regular Snapshot ==="
          ginkgo -v --focus="should create and restore from a regular snapshot" ./tests/e2e/iscsi/...

  iscsi-detached-snapshot:
    name: "iSCSI: Detached Snapshot (zfs send/receive)"
    runs-on: new
    timeout-minutes: 25
    needs: compute-tag
    if: |
      !cancelled() && needs.compute-tag.result == 'success' &&
      (github.event.inputs.protocol == '' || github.event.inputs.protocol == 'iscsi') &&
      (github.event.inputs.scenario == '' || github.event.inputs.scenario == 'detached-snapshot')
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
      - uses: fenio/setup-k3s@v5
        with:
          k3s-args: '--write-kubeconfig-mode 644 --disable=traefik --disable=local-storage'
      - uses: ./.github/actions/setup-snapshots
      - name: Install Ginkgo
        run: go install github.com/onsi/ginkgo/v2/ginkgo@latest
      - name: Run Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
          KUBECONFIG: /etc/rancher/k3s/k3s.yaml
        run: |
          echo "=== iSCSI: Detached Snapshot (survives source deletion) ==="
          ginkgo -v --focus="Detached Snapshot" ./tests/e2e/iscsi/...

  iscsi-volume-clone-cow:
    name: "iSCSI: Volume Clone (COW)"
    runs-on: new
    timeout-minutes: 20
    needs: compute-tag
    if: |
      !cancelled() && needs.compute-tag.result == 'success' &&
      (github.event.inputs.protocol == '' || github.event.inputs.protocol == 'iscsi') &&
      (github.event.inputs.scenario == '' || github.event.inputs.scenario == 'volume-clone-cow')
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
      - uses: fenio/setup-k3s@v5
        with:
          k3s-args: '--write-kubeconfig-mode 644 --disable=traefik --disable=local-storage'
      - uses: ./.github/actions/setup-snapshots
      - name: Install Ginkgo
        run: go install github.com/onsi/ginkgo/v2/ginkgo@latest
      - name: Run Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
          KUBECONFIG: /etc/rancher/k3s/k3s.yaml
        run: |
          echo "=== iSCSI: Volume-to-Volume Clone (COW - space efficient) ==="
          ginkgo -v --focus="Volume Clone" ./tests/e2e/iscsi/...

  # ==========================================
  # Summary
  # ==========================================

  matrix-summary:
    name: "Matrix Summary"
    runs-on: new
    timeout-minutes: 5
    needs:
      - nfs-regular-snapshot
      - nfs-detached-snapshot
      - nfs-snapshot-restore-cow
      - nfs-volume-clone-cow
      - nvmeof-regular-snapshot
      - nvmeof-detached-snapshot
      - nvmeof-snapshot-restore-cow
      - nvmeof-volume-clone-cow
      - iscsi-regular-snapshot
      - iscsi-detached-snapshot
      - iscsi-volume-clone-cow
    if: always()
    steps:
      - name: Generate Matrix Summary
        uses: actions/github-script@v8
        with:
          script: |
            const scenarios = {
              'Regular Snapshot': {
                'NFS': '${{ needs.nfs-regular-snapshot.result }}',
                'NVMe-oF': '${{ needs.nvmeof-regular-snapshot.result }}',
                'iSCSI': '${{ needs.iscsi-regular-snapshot.result }}',
              },
              'Detached Snapshot': {
                'NFS': '${{ needs.nfs-detached-snapshot.result }}',
                'NVMe-oF': '${{ needs.nvmeof-detached-snapshot.result }}',
                'iSCSI': '${{ needs.iscsi-detached-snapshot.result }}',
              },
              'Snapshot Restore': {
                'NFS': '${{ needs.nfs-snapshot-restore-cow.result }}',
                'NVMe-oF': '${{ needs.nvmeof-snapshot-restore-cow.result }}',
                'iSCSI': 'skipped',
              },
              'Volume Clone': {
                'NFS': '${{ needs.nfs-volume-clone-cow.result }}',
                'NVMe-oF': '${{ needs.nvmeof-volume-clone-cow.result }}',
                'iSCSI': '${{ needs.iscsi-volume-clone-cow.result }}',
              },
            };

            const getIcon = (result) => {
              switch(result) {
                case 'success': return ':white_check_mark:';
                case 'failure': return ':x:';
                case 'skipped': return ':fast_forward:';
                case 'cancelled': return ':no_entry:';
                default: return ':white_circle:';
              }
            };

            let summary = `# Snapshot & Clone Matrix Results\n\n`;
            summary += `| Scenario | NFS | NVMe-oF | iSCSI |\n`;
            summary += `|----------|:---:|:-------:|:-----:|\n`;

            let passed = 0, failed = 0;
            for (const [scenario, protocols] of Object.entries(scenarios)) {
              summary += `| ${scenario} |`;
              for (const protocol of ['NFS', 'NVMe-oF', 'iSCSI']) {
                const result = protocols[protocol];
                summary += ` ${getIcon(result)} |`;
                if (result === 'success') passed++;
                else if (result === 'failure') failed++;
              }
              summary += `\n`;
            }

            summary += `\n## Legend\n`;
            summary += `- :white_check_mark: Success\n`;
            summary += `- :x: Failed\n`;
            summary += `- :fast_forward: Skipped\n`;
            summary += `- :no_entry: Cancelled\n`;

            summary += `\n## Terminology\n`;
            summary += `- **Regular Snapshot**: Standard ZFS COW snapshot (depends on source volume)\n`;
            summary += `- **Detached Snapshot**: Independent copy via zfs send/receive (survives source deletion)\n`;
            summary += `- **Snapshot Restore**: Clone from snapshot (space efficient, snapshot cannot be deleted while clone exists)\n`;
            summary += `- **Volume Clone**: Clone from volume via temp snapshot (space efficient, shares blocks with source)\n`;

            await core.summary.addRaw(summary).write();

            if (failed > 0) {
              core.setFailed(`${failed} scenario(s) failed`);
            }
